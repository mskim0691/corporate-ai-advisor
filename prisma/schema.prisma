generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  passwordHash      String              @map("password_hash")
  name              String?
  role              String              @default("user") // 'user' or 'admin'
  credits           Int                 @default(0) // [DEPRECATED - 크레딧 기능 비활성화] User's credit balance
  createdAt         DateTime            @default(now()) @map("created_at")
  subscription      Subscription?
  usageLogs         UsageLog[]
  projects          Project[]
  paymentLogs       PaymentLog[]
  announcements     Announcement[]
  creditTransactions CreditTransaction[] // [DEPRECATED - 크레딧 기능 비활성화]
  inquiries         Inquiry[]

  @@map("users")
}

model Subscription {
  id                   String    @id @default(uuid())
  userId               String    @unique @map("user_id")
  plan                 String    @default("free") // 'free', 'pro', or 'expert'
  pendingPlan          String?   @map("pending_plan") // Scheduled plan change (applied at next billing)
  status               String    @default("active")
  stripeSubscriptionId String?   @map("stripe_subscription_id") // Legacy field, now used for billingKey
  billingKey           String?   @map("billing_key") // TossPayments billing key for auto-payment
  customerKey          String?   @map("customer_key") // TossPayments customer key
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  createdAt            DateTime  @default(now()) @map("created_at")
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model UsageLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  yearMonth String   @map("year_month") // Format: '2025-01'
  count     Int      @default(0)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, yearMonth])
  @@map("usage_logs")
}

model Project {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  companyName    String   @map("company_name")
  businessNumber String   @map("business_number")
  representative String
  industry       String?
  status         String   @default("pending") // 'pending', 'processing', 'completed', 'failed'
  createdAt      DateTime @default(now()) @map("created_at")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  files          File[]
  report         Report?

  @@map("projects")
}

model File {
  id         String   @id @default(uuid())
  projectId  String   @map("project_id")
  filename   String
  filePath   String   @map("file_path")
  fileType   String?  @map("file_type")
  fileSize   Int?     @map("file_size")
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("files")
}

model Report {
  id                    String    @id @default(uuid())
  projectId             String    @unique @map("project_id")
  reportType            String    @default("solution") @map("report_type") // 'solution' or 'presentation'
  initialRiskAnalysis   String?   @map("initial_risk_analysis") // Initial risk analysis (step 0)
  additionalRequest     String?   @map("additional_request") // User's additional analysis request
  supplementaryInfo     String?   @map("supplementary_info") // User's supplementary information for regeneration
  textAnalysis          String?   @map("text_analysis") // Detailed analysis result (step 1)
  analysisData          String?   @map("analysis_data") // JSON string for slides (step 2)
  pdfUrl                String?   @map("pdf_url")
  regenerationCount     Int       @default(0) @map("regeneration_count") // Number of times solution was regenerated (max 1)
  meetingNotes          String?   @map("meeting_notes") // User's meeting notes after client meeting
  followupAnalysis      String?   @map("followup_analysis") // AI-generated followup analysis based on meeting notes
  shareToken            String?   @unique @map("share_token")
  sharePassword         String?   @map("share_password")
  shareExpiresAt        DateTime? @map("share_expires_at")
  viewCount             Int       @default(0) @map("view_count")
  createdAt             DateTime  @default(now()) @map("created_at")
  project               Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model Prompt {
  id          String   @id @default(uuid())
  name        String   @unique // 'initial_risk', 'detailed_analysis', 'presentation'
  content     String   // The actual prompt text
  description String?  // Description of what this prompt does
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("prompts")
}

model PaymentLog {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  amount          Float    // Payment amount
  currency        String   @default("KRW")
  paymentMethod   String?  @map("payment_method") // 'card', 'transfer', etc.
  status          String   // 'pending', 'completed', 'failed', 'refunded'
  transactionId   String?  @unique @map("transaction_id") // External payment ID
  description     String?  // Payment description
  paidAt          DateTime? @map("paid_at")
  createdAt       DateTime @default(now()) @map("created_at")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_logs")
}

model GroupPolicy {
  id                      String   @id @default(uuid())
  groupName               String   @unique @map("group_name") // 'admin', 'pro', 'free'
  monthlyProjectLimit     Int      @map("monthly_project_limit") // Number of analysis solutions allowed per month
  monthlyPresentationLimit Int     @default(0) @map("monthly_presentation_limit") // Number of PT reports allowed per month
  description             String?  // Description of the policy
  updatedAt               DateTime @updatedAt @map("updated_at")
  createdAt               DateTime @default(now()) @map("created_at")

  @@map("group_policies")
}

model Announcement {
  id          String   @id @default(uuid())
  title       String   // Announcement title
  content     String   // Announcement content (supports markdown)
  priority    Int      @default(0) // Higher priority shows first
  isActive    Boolean  @default(true) @map("is_active") // Whether the announcement is visible
  startDate   DateTime? @map("start_date") // Optional start date for scheduled announcements
  endDate     DateTime? @map("end_date") // Optional end date for automatic hiding
  authorId    String   @map("author_id") // Admin who created the announcement
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("announcements")
}

model PricingPlan {
  id                String   @id @default(uuid())
  name              String   @unique // 'free', 'standard', etc.
  displayName       String   @map("display_name") // Display name (e.g., "Free", "Standard")
  price             Float    // Monthly price
  originalPrice     Float?   @map("original_price") // Original price (for showing discount)
  currency          String   @default("KRW") // Currency
  monthlyAnalysis   Int      @map("monthly_analysis") // Number of analysis solutions per month
  monthlyPresentation Int    @default(0) @map("monthly_presentation") // Number of visual reports per month
  features          String   // JSON string of features array
  isPopular         Boolean  @default(false) @map("is_popular") // Show "popular" badge
  isActive          Boolean  @default(true) @map("is_active") // Whether the plan is visible
  displayOrder      Int      @default(0) @map("display_order") // Display order on page
  badgeText         String?  @map("badge_text") // Optional badge text (e.g., "50% 할인 이벤트")
  badgeColor        String?  @map("badge_color") // Badge color (e.g., "red", "blue")
  buttonText        String   @default("시작하기") @map("button_text") // CTA button text
  buttonVariant     String   @default("default") @map("button_variant") // Button style variant
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("pricing_plans")
}

// [DEPRECATED - 크레딧 기능 비활성화] Credit transaction tracking model - no longer used in application
model CreditTransaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  amount      Int      // Positive for credit, negative for debit
  type        String   // 'purchase', 'admin_grant', 'admin_deduct', 'analysis_cost', 'presentation_cost'
  description String?  // Description of the transaction
  relatedId   String?  @map("related_id") // Related project/payment ID
  adminId     String?  @map("admin_id") // Admin who performed the transaction (if applicable)
  balanceAfter Int     @map("balance_after") // User's credit balance after this transaction
  createdAt   DateTime @default(now()) @map("created_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("credit_transactions")
  @@index([userId, createdAt])
}

// [DEPRECATED - 크레딧 기능 비활성화] Credit pricing model - no longer used in application
model CreditPrice {
  id          String   @id @default(uuid())
  type        String   @unique // 'basic_analysis', 'premium_presentation'
  name        String   // Display name
  credits     Int      // Credit cost
  description String?  // Description
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("credit_prices")
}

model SampleReport {
  id        String   @id @default(uuid())
  imageUrl  String   @map("image_url") // URL of the sample image
  order     Int      @default(0) // Display order
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sample_reports")
  @@index([order])
}

// [DEPRECATED - 크레딧 기능 비활성화] Initial credit policy model - no longer used in application
model InitialCreditPolicy {
  id          String   @id @default(uuid())
  credits     Int      // Initial credits to grant on registration
  description String?  // Description of the policy
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("initial_credit_policies")
}

model Inquiry {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String   // Inquiry title
  content     String   // Inquiry content
  reply       String?  // Admin reply
  repliedAt   DateTime? @map("replied_at") // When admin replied
  status      String   @default("pending") // 'pending' or 'answered'
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("inquiries")
  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model Banner {
  id          String   @id @default(uuid())
  title       String   // Banner title
  subtitle    String?  // Banner subtitle
  description String?  // Banner description
  buttonText  String?  @map("button_text") // CTA button text
  buttonLink  String?  @map("button_link") // CTA button link
  imageUrl    String?  @map("image_url") // Background image URL
  bgColor     String?  @map("bg_color") // Background color (e.g., 'bg-blue-600')
  textColor   String?  @map("text_color") // Text color (e.g., 'text-white')
  order       Int      @default(0) // Display order (lower = first)
  isActive    Boolean  @default(true) @map("is_active") // Whether the banner is visible
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("banners")
  @@index([order])
}

model ServiceIntro {
  id        String   @id @default(uuid())
  content   String   // HTML content for the service introduction page
  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("service_intros")
}

model LegalDocument {
  id        String   @id @default(uuid())
  type      String   @unique // 'terms' or 'privacy'
  title     String   // Document title
  content   String   // HTML content
  version   String   @default("1.0") // Version number
  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("legal_documents")
}

model Coupon {
  id            String    @id @default(uuid())
  code          String    @unique // Format: XXXX-XXXX-XXXX-XXXX
  plan          String    @default("pro") // Plan to apply when redeemed
  durationDays  Int       @default(30) @map("duration_days") // Duration in days
  redeemedBy    String?   @map("redeemed_by") // User ID who redeemed
  redeemedAt    DateTime? @map("redeemed_at") // When the coupon was redeemed
  expiresAt     DateTime? @map("expires_at") // When the applied plan expires
  batchId       String?   @map("batch_id") // For grouping coupons created together
  note          String?   // Optional note for admin
  createdAt     DateTime  @default(now()) @map("created_at")

  @@map("coupons")
  @@index([code])
  @@index([redeemedBy])
  @@index([batchId])
}
